
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel with Toolbar and Preview</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-direction: column;
            margin: 0;
        }
        .header {
            width: 100%;
            background-color: #007bff;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
        .header button {
            padding: 10px 15px;
            background-color: white;
            color: #007bff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .header button:hover {
            background-color: #f0f0f0;
        }
        .admin-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width:97%;
            margin-top: 80px;
            text-align: center;
        }
        #postContent {
            display: none;
            margin-bottom: 20px;
        }
        button {
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .posts {
          
            margin-top: 20px;
            text-align: left;
        }
        .post {
         
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
      
        #toolbar {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        #toolbar button {
            margin-right: 5px;
        }
        input[type="text"] {
            width: 98%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .posts {
            margin-top: 20px;
        }
        .generatedHTML {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        } 
        postcontent{display:none;}
        .status {display:inline-block;
            color: gray;
            font-size: 12px;
        }
        
     
    </style>
</head>
<body>

    <div class="header">
        <button id="createPostButton">Create a New Post</button>
        <button id="logoutButton">Logout</button>
    </div>

    <div class="admin-container">
        <h2>Admin Panel</h2>

        <!-- Title Input -->
        <input type="text" id="postTitle" placeholder="Enter Post Title" style="display: none;" />

        <!-- Toolbar for formatting -->
        <div id="toolbar" style="display: none;">
            <button onclick="execCmd('bold')">Bold</button>
            <button onclick="execCmd('justifyLeft')">Left</button>
            <button onclick="execCmd('justifyCenter')">Center</button>
            <button onclick="execCmd('justifyRight')">Right</button>
        </div>

        <!-- Content editor -->
        <div contenteditable="true" id="postContent" style="width: 98%; padding: 10px; border: 1px solid #ddd; min-height: 150px; margin-top: 10px; display: none;"></div>

        <!-- Generated HTML Display -->
        <div id="generatedHTML" class="generatedHTML" style="display: none;"></div>

        <!-- Buttons -->
        <button id="submitPost" style="display: none;">Submit Post</button>
        <button id="previewPost" style="display: none;">Preview in New Tab</button>

        <!-- Posts Display -->
        <div id="posts" class="posts"></div>
    </div>

   <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, doc, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBFH1SGy9Gc7JJZhTLv2bktvTE4q_mSU3M",
        authDomain: "gklearnstudyy.firebaseapp.com",
        projectId: "gklearnstudyy",
        storageBucket: "gklearnstudyy.appspot.com",
        messagingSenderId: "256328121620",
        appId: "1:256328121620:web:6de8ba9ae25e83c4875601"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentEditPostId = null;

    document.addEventListener('DOMContentLoaded', function () {
        const logoutButton = document.getElementById('logoutButton');
        const saveDraftButton = document.createElement('button');
        saveDraftButton.innerText = 'Save as Draft';
        saveDraftButton.style.display = 'none';
        document.body.appendChild(saveDraftButton);

        const submitButton = document.getElementById('submitPost');
        const createPostButton = document.getElementById('createPostButton');
        const postsContainer = document.getElementById('posts');
        const editorContainer = document.getElementById('postContent');
        const generatedHTML = document.getElementById('generatedHTML');
        const previewButton = document.getElementById('previewPost');
        const editPreviewButton = document.createElement('button');
        editPreviewButton.id = 'editpreviewPost';
        editPreviewButton.innerText = 'Preview in New Tab';
        editPreviewButton.style.display = 'none';
        document.body.appendChild(editPreviewButton);
        const postTitleInput = document.getElementById('postTitle');

        loadPosts();

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        logoutButton.addEventListener('click', handleLogout);

        createPostButton.addEventListener('click', function () {
            resetEditor();
            postTitleInput.style.display = 'block';
            editorContainer.style.display = 'block';
            submitButton.style.display = 'inline-block';
            previewButton.style.display = 'inline-block';
            saveDraftButton.style.display = 'inline-block';
            editPreviewButton.style.display = 'none';
            document.getElementById('toolbar').style.display = 'block';
            postsContainer.style.display = 'none';
        });

        previewButton.addEventListener('click', function () {
            const content = editorContainer.innerHTML;
            const title = postTitleInput.value;
            const dynamicTags = generateDynamicTags(title);
            if (content && title) {
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(`<h1>${title}</h1>${dynamicTags}${content}`);
                previewWindow.document.close();
            } else {
                alert('Please fill in the title and content to preview.');
            }
        });

        editPreviewButton.addEventListener('click', function () {
            const content = editorContainer.innerHTML;
            const title = postTitleInput.value;
            const dynamicTags = generateDynamicTags(title);
            if (content && title) {
                const previewWindow = window.open('', '_blank');
                previewWindow.document.write(`<h1>${title}</h1>${dynamicTags}${content}`);
                previewWindow.document.close();
            } else {
                alert('Please fill in the title and content to preview.');
            }
        });

        function execCmd(command, value = null) {
            document.execCommand(command, false, value);
            updateOutput();
        }

        function updateOutput() {
            const content = editorContainer.innerHTML;
            const title = postTitleInput.value;
            
            generatedHTML.innerText = `${dynamicTags}\n${content}`;
            const dynamicTags = generateDynamicTags(title);
            generatedHTML.style.display = 'block';
        }

        editorContainer.addEventListener('input', updateOutput);

        async function createPost(status) {
            const user = auth.currentUser;
            const postContent = editorContainer.innerHTML;
            const postTitle = postTitleInput.value;

            if (await isTitleTaken(postTitle) && !currentEditPostId && status !== "none") {
                alert("Post title already taken. Please choose another.");
                return;
            }

            if (postContent && postTitle && user) {
                try {
                    const postData = {
                        title: postTitle,
                        content: postContent,
                        status: status,
                        userId: user.uid,
                        userName: user.displayName || user.email,
                        createdAt: new Date() // Timestamp for sorting
                    };

                    if (currentEditPostId) {
                        await updateDoc(doc(db, "posts", currentEditPostId), postData);
                        if (status === "none") {
                            alert('Post has been saved as draft!');
                        } else {
                            alert('Post resubmitted successfully!');
                        }
                    } else {
                        await addDoc(collection(db, "posts"), postData);
                        if (status === "none") {
                            alert('Post saved successfully as draft!');
                        } else {
                            alert('Post submitted successfully!');
                        }
                    }

                    loadPosts();
                    resetEditor();
                } catch (error) {
                    console.error("Error adding/updating document: ", error);
                }
            } else {
                alert('Please provide both title and content.');
            }
        }

        submitButton.addEventListener('click', function() {
            createPost("Pending");
        });

        saveDraftButton.addEventListener('click', function() {
            createPost("none");
        });

        async function isTitleTaken(title) {
            const postsQuery = query(collection(db, "posts"), where("title", "==", title));
            const querySnapshot = await getDocs(postsQuery);
            return !querySnapshot.empty;
        }

        async function loadPosts() {
            const postsQuery = query(collection(db, "posts"), orderBy("createdAt", "desc")); // Order by creation time
            const postsSnapshot = await getDocs(postsQuery);
            postsContainer.innerHTML = '';

            const user = auth.currentUser;
            const isAdmin = user.email === "admin@example.com";

            postsSnapshot.forEach((doc) => {
                const post = doc.data();
                const postElement = document.createElement('div');
                postElement.className = 'post';

                if (isAdmin || post.userId === user.uid) {
                    const previewButton = document.createElement('button');
                    previewButton.innerText = 'Preview';
                    previewButton.onclick = function () {
                        const previewWindow = window.open('', '_blank');
                        const dynamicTags = generateDynamicTags(post.title);
                        previewWindow.document.write(`<h1>${post.title}</h1>${dynamicTags}${post.content}`);
                        previewWindow.document.close();
                    };

                    const editButton = document.createElement('button');
                    editButton.innerText = 'Edit';
                    editButton.onclick = function () {
                        currentEditPostId = doc.id;
                        postTitleInput.value = post.title;
                        editorContainer.innerHTML = post.content;
                        postTitleInput.style.display = 'block';
                        editorContainer.style.display = 'block';
                        submitButton.style.display = 'inline-block';
                        saveDraftButton.style.display = 'inline-block';
                        editPreviewButton.style.display = 'inline-block';
                        previewButton.style.display = 'none';
                        postsContainer.style.display = 'none';
                        document.getElementById('toolbar').style.display = 'block';
                    };

                    postElement.innerHTML = 
                        `<h3>${post.title}</h3>
                        <postcontent>${post.content}</postcontent>
                        <status>Status: ${post.status === "none" ? "Draft" : post.status}</status>
                        <div>Posted by: ${post.userName}</div>`; // Show username
                    postElement.appendChild(previewButton);
                    postElement.appendChild(editButton);
                    postsContainer.appendChild(postElement);
                    previewButton.style.float = 'right';
                    previewButton.style.marginTop = '-10px';
                    previewButton.style.padding = '5px';
                    editButton.style.float = 'right';
                    editButton.style.marginTop = '-10px';
                    editButton.style.marginRight = '5px';
                    editButton.style.padding = '5px';
                }
            });

            if (postsContainer.innerHTML === '') {
                postsContainer.innerHTML = '<p>No posts found.</p>';
            }
        }

        function resetEditor() {
            currentEditPostId = null;
            editorContainer.innerHTML = '';
            postTitleInput.value = '';
            editorContainer.style.display = 'none';
            submitButton.style.display = 'none';
            saveDraftButton.style.display = 'none'; 
            editPreviewButton.style.display = 'none';
            previewButton.style.display = 'none';
            postTitleInput.style.display = 'none';
            postsContainer.style.display = 'block';
        }

        async function handleLogout() {
            await signOut(auth);
            window.location.href = 'login.html';
        }

       
       function generateDynamicTags(title) {
            const prefix = title.split('/').map(() => '..').join('/');
            const scriptTag1 = `<script src="${prefix}/script.js"><\/script>`;
            const scriptTag2 = `<script src="${prefix}/search.js"><\/script>`;
            const scriptTag3 = `<script src="${prefix}/menusearch.js"><\/script>`;
            const styleTag = `<link rel="stylesheet" href="${prefix}/style.css">`;

            return `${styleTag}\n${scriptTag1}\n${scriptTag2}\n${scriptTag3}`;
        }
        async function handleLogout() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("Error logging out: ", error);
            }
        }
    });
</script>


<script>
    function execCmd(command, value = null) {
        document.execCommand(command, false, value);
        updateOutput();
    }

    function updateOutput() {
        const editorContent = document.getElementById('editor').innerHTML;
        document.getElementById('output').value = editorContent;
    }

    document.getElementById('editor').addEventListener('input', updateOutput);
</script>



</body>
</html>
